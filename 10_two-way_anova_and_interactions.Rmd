---
title       : Дисперсионный анализ, часть 2
subtitle    : Линейные модели, осень 2015
author: Марина Варфоломеева, Вадим Хайтов
presenters: [{
    name: 'Марина Варфоломеева',
    company: 'каф. ЗБП, СПбГУ',
    }]
output:
  ioslides_presentation:
    widescreen: true
    css: my_styles.css
    logo: Linmod_logo.png
---

## Многофакторный дисперсионный анализ

- Модель многофакторного дисперсионного анализа
- Взаимодействие факторов
- Несбалансированные данные, типы сумм квадратов
- Многофакторный дисперсионный анализ в R
- Дисперсионный анализ в матричном виде

### Вы сможете

- Проводить многофакторный дисперсионный анализ и интерпретироваот его результаты с учетом взаимодействия факторов

```{r setup, include = FALSE, cache = FALSE}
#-- RUN THE FRAGMENT BETWEEN LINES BEFORE COMPILING MARKDOWN
# to configure markdown parsing
options(markdown.extensions = c("no_intra_emphasis", "tables", "fenced_code", "autolink", "strikethrough", "lax_spacing", "space_headers", "latex_math"))
#------
# output options
options(width = 70, scipen = 6, digits = 3)

# to render cyrillics in plots use cairo pdf
options(device = function(file, width = 7, height = 7, ...) {
  cairo_pdf(tempfile(), width = width, height = height, ...)
  })
library(knitr)
# chunk default options
opts_chunk$set(fig.align='center', tidy = TRUE, fig.width = 7, fig.height = 3, message=FALSE, warning=FALSE)
```

# Модель многофакторного дисперсионного анализа



## Линейные модели с разным числом дискретных предикторов

- Два фактора A и B, двухфакторное взаимодействие

$y _{ijk} = \mu + \alpha _i + \beta _j + (\alpha \beta) _{ij} + \epsilon _{ijk}$

<br /><br />

- Три фактора A, B и C, двухфакторные взаимодействия, трехфакторное взаимодействия

$y _{ijkl} = \mu + \alpha _i + \beta _j + \gamma _k + (\alpha \beta) _{ij} + (\alpha \gamma) _{ik} + (\beta \gamma) _{jk} + (\alpha \beta \gamma) _{ijk} + \epsilon _{ijkl}$



# Взаимодействие дискретных предикторов



## Взаимодействие дискретных предикторов

Взаимодействие факторов - когда эффект фактора B разный в зависимости от уровней фактора A и наоборот

<div class="columns-2">

На каких рисунках есть взаимодействие факторов?

>- b, c - нет взаимодействия (эффект фактора B одинаковый для групп по фактору A, линии для разных групп по фактору B на графиках расположены параллельно)
- a, d - есть взаимодействие (эффект фактора B разный для групп по фактору A, на графиках линии для разных групп по фактору B расположены под наклоном).

![Взаимодействие факторов](images/interaction.png "Взаимодействие факторов")
</div>

<div class = "footnote">Рисунок из Logan, 2010, fig.12.2</div>


## Влияют ли главные эффекты и взаимодействие?

![Взаимодействие факторов](images/interaction1a.png "Взаимодействие факторов")

> - взаимодействие достоверно, и не маскирует главные эффекты
- фактор А влияет
- фактор В влияет

<div class = "footnote">Рисунок из Quinn, Keough, 2002, fig.9.3</div>



## Влияют ли главные эффекты и взаимодействие?

![Взаимодействие факторов](images/interaction1b.png "Взаимодействие факторов")

> - взаимодействие достоверно и мешает интерпретировать влияние факторов отдельно:
    - для В2 зависимая переменная возрастает с изменением уровня А
    - для В1 зависимая переменная возрастает только на А2, но не различается на А1 и А3
> - если смотреть на главные эффекты, можно сделать неправильные выводы:
    - фактор А влияет, группы А2 и А3 не отличаются
    - фактор В влияет, в группе В2 зависимая переменная больше, чем в В1

<div class = "footnote">Рисунок из Quinn, Keough, 2002, fig.9.3</div>



## Влияют ли главные эффекты и взаимодействие?

![Взаимодействие факторов](images/interaction1c.png "Взаимодействие факторов")

> - взаимодействие достоверно и мешает интерпретировать влияние факторов отдельно:
    - А1В2, А3В2 и А2В1 не различаются, значение зависимой переменной в этих группах выше, чем в остальных
    - А1В1, А3В1 и А2В2 не различаются
> - если смотреть на главные эффекты, можно сделать неправильные выводы:
    - факторы А и В не влияют

<div class = "footnote">Рисунок из Quinn, Keough, 2002, fig.9.3</div>



## Взаимодействие факторов может маскировать главные эффекты

<div class="column-2">
- Если есть значимое взаимодействие
  - главные эффекты обсуждать не имеет смысла  
  - пост хок тесты проводятся только для ваимодействия


![Взаимодействие факторов](images/interaction1.png "Взаимодействие факторов")

</div>

<div class = "footnote">Рисунок из Quinn, Keough, 2002, fig.9.3</div>


# Несбалансированные данные, типы сумм квадратов

## Несбалансированные данные - когда численности в группах по факторам различаются

<div class="columns-2">

Например так,

|    | A1 | A2 | A3 |
|----|----|----|----|
| B1 |  5 | 5  |  5 |
| B2 |  5 | 4  |  5 |


или так,


|    | A1 | A2 | A3 |
|----|----|----|----|
| B1 |  3 | 8  |  4 |
| B2 |  4 | 7  |  4 |

</div>

## Проблемы несбалансированных дизайнов

> - Оценки средних в разных группах с разным уровнем точности (Underwood 1997)
- ANOVA менее устойчив к отклонениям от условий применимости (особенно от гомогенности дисперсий) при разных размерах групп (Quinn Keough 2002, section 8.3)
- Проблемы с рассчетом мощности. Если $\sigma _{\epsilon}^2 > 0$ и размеры выборок разные, то $MS _{factor} \over MS _{residuals}$ не следует F-распределению (Searle et al. 1992).

<br /><br />

> - Cтарайтесь _планировать_ группы равной численности!
> - Но если не получилось - не страшно:
    - Для фикс. эффектов неравные размеры - проблема только если значения доверительной вероятности _p_ близки к выбранному критическому уровню значимости $\alpha$

## Если несбалансированные данные, выберите правильный тип сумм квадратов

- SSe и SSab также как в сбалансированных
- SSa, SSb - три способа расчета

- Для сбалансированных дизайнов - результаты одинаковы
- Для несбалансированных дизайнов рекомендуют __суммы квадратов III типа__ если есть взаимодействие факторов (Maxwell & Delaney 1990, Milliken, Johnson 1984, Searle 1993, Yandell 1997)

## Типы сумм квадратов в дисперсионном анализе

Типы сумм квадратов | I тип | II тип | III тип
- | - | -- | -
Название | Последовательная | Без учета взаимодействий высоких порядков | Иерархическая
SS | SS(A),<br />SS(B &#8739; A)<br />SS(AB &#8739; B, A) | SS(A &#8739; B)<br />SS(B &#8739; A)<br />SS(AB &#8739; B, A) | SS(A &#8739; B, AB)<br />SS(B &#8739; A, AB)<br />SS(AB &#8739; B, A)
Величина эффекта зависит от выборки в группе | Да | Да | Нет
Результат зависит от порядка включения факторов в модель | Да | Нет | Нет
Команда R | `aov()` | `Anova()` (пакет `car`) |  `Anova()` (пакет `car`) 



# Многофакторный дисперсионный анализ в R

## Пример: Удобрение и беспозвоночные

Влияет ли добавление азотных и фосфорных удобрений на беспозвоночных?

Небольшие искуственные субстраты экспонировали в течение разного времени в верхней части сублиторали (Hall et al., 2000).

Факторы:

- срок экспозиции (2, 4 и 6 месяцев)
- удобрения (добавляли или нет)

Планировали сделать 5 повторностей для каждого сочетания факторов

Зависимая переменная:

- Число видов

<div class = "footnote">Данные из Quinn, Keough, 2002</div>

## Знакомимся с данными

```{r, message = FALSE}
dat <- read.csv(file="data/hall.csv")
str(dat)
# Для удобства названия переменных маленькими буквами
colnames(dat) <- tolower(colnames(dat))
# Время делаем фактором
dat$time <- factor(dat$time)
levels(dat$time)
```

## Пропущенные значения

```{r}
sum(is.na(dat))
sapply(dat, function(x)sum(is.na(x)))
```

> - Нет пропущенных значений

## Объемы выборок в группах

```{r}
table(dat$time, dat$treat)
```

> - Группы разного размера. Выбираем 3 тип сумм квадратов

##   Посмотрим на боксплот

```{r, fig.height = 4}
library(ggplot2)
theme_set(theme_bw(base_size = 18) + theme(legend.key = element_blank()))
gg_rich <- ggplot(data = dat, aes(x = treat, y = richness, colour = time)) + 
  geom_boxplot()
gg_rich
```

## Преобразовываем данные

На боксплоте видна гетерогенность дисперсий. И 
это неспроста!

Зависимая переменная `richness` -- это счетная величина. Она подчиняется распределению Пуассона (и чем больше ее среднее значение, тем больше дисперсия). 

Правильно было бы воспользоваться обобщенными линейными моделями с Пуассоновским распределением ошибок вместо нормального. Но пока что мы попробуем преобразовать зависимую переменную, чтобы ее распределение стало больше походить на нормальное. Это может помочь, а может и нет.

```{r}
dat$log_rich <- log10(dat$richness + 1)
```


## Линейная модель

Внимание: при использовании III типа сумм квадратов, нужно __обязательно указывать тип контрастов для факторов__ (`contrasts=list(фактор_1 = contr.sum, фактор_2=contr.sum)`).

```{r tidy.opts=list(width.cutoff=40)}
fit <- lm(log_rich ~ treat * time, data = dat, contrasts = list(treat = contr.sum, time = contr.sum))
```

## Задание: Проверьте условия применимости дисперсионного анализа

- Есть ли гомогенность дисперсий?
- Не видно ли трендов в остатках?
- Нормальное ли у остатков распределение?

## Решение: 1. Проверяем условия применимости

- Есть ли гомогенность дисперсий?
- Не видно ли трендов в остатках?

```{r fig.height=4}
library(car)
residualPlots(fit)
```

> - Все хорошо

## Решение: 2. Проверяем условия применимости

- Нормальное ли у остатков распределение?

```{r}
qqPlot(fit)
```

> - Все хорошо

## Результаты дисперсионного анализа {.smaller}

<div class="columns-2">

```{r, R.options=list(width = 45)}
Anova(fit, type = 3)
```

> - Поскольку взаимодействие достоверно, факторы отдельно можно не тестировать. Проведем пост хок тест по взаимодействию, чтобы выяснить, какие именно группы различаются

```{r, echo=FALSE, fig.width=4, fig.height=4.5}
gg_rich + guides(fill=guide_legend(ncol=3)) + theme(legend.position = "bottom") 
```

</div>

## Пост хок тест

```{r phoc, eval=FALSE}
# 1. создаем переменную-взаимодействие 
dat$treat_time <- interaction(dat$treat, dat$time)

# 2. подбираем модель без intercept 
fit_inter <- lm(log_rich ~ treat_time - 1, data = dat)

# 3. делаем пост хок тест
library(multcomp)
dat_tukey <- glht(fit_inter, linfct = mcp(treat_time = "Tukey"))
summary(dat_tukey)
```

## Смотрим на результаты пост хок теста {.smaller}

```{r phoc, echo=FALSE}
```


## Данные для графиков

```{r, tidy=FALSE}
library(dplyr)
dat_summary <- dat %>% 
  group_by(treat, time) %>% 
  summarise(
    .mean = mean(richness),
    .sd = sd(richness),
    .n = sum(!is.na(richness)),
    .se = .sd/sqrt(.n),
    lwr = .mean - qnorm(0.975) * .se,
    upr = .mean + qnorm(0.975) * .se)
dat_summary
```

## Графики для результатов: Столбчатый график

```{r tidy.opts=list(width.cutoff=60)}
pos <- position_dodge(width = 0.9)
gg_barp <- ggplot(data = dat_summary, aes(x = treat, y = .mean, ymin = lwr,  ymax = upr, fill = time)) +  
  geom_bar(stat = "identity", position = pos) +  
  geom_errorbar(width = 0.1, position = pos)
gg_barp
```


## Графики для результатов: Линии с точками

```{r tidy.opts=list(width.cutoff=60)}
gg_linep <- ggplot(data = dat_summary, aes(x = treat, y = .mean, ymin = lwr,  ymax = upr, colour = time)) + 
  geom_point(size = 3, position = pos) +
  geom_line(aes(group = time), position = pos) +
  geom_errorbar(width = 0.1, position = pos) 
gg_linep
```

## Какой график лучше выбрать?

```{r message = FALSE, fig.width = 10, fig.height = 4}
library(gridExtra)
grid.arrange(gg_barp, gg_linep, ncol = 2)
```

>- Должен быть максимум данных в минимуме чернил (Tufte, 1983)

## Приводим понравившийся график в приличный вид

```{r tidy.opts=list(width.cutoff=60)}
gg_final <- gg_linep + labs(x = "Эксперимент",  y = "Число видов") + 
  scale_x_discrete(labels = c("Контроль", "Удобрения")) + 
  scale_colour_brewer(name = "Экспозиция", palette = "Dark2", labels = c("2 месяца", "4 месяца", "6 месяцев"))
gg_final
```

# Регрессия в матричном виде

## Регрессия в матричном виде

Уравнение простой линейной регрессии:

$$y _{i} = \beta _0 + \beta _1 x _i + \epsilon _{i}$$

Здесь $i = 1, ..., n$, т.е. порядковый номер наблюдения

Если расписать эту формулу, получится по отдельному уравнению для каждого из наблюдений:

$$\begin{align*}
y &_{1} = \beta _0 + \beta _1 x _1 + \epsilon _{1} \\
y &_{2} = \beta _0 + \beta _1 x _2 + \epsilon _{2} \\
&\vdots \\
y &_{n} = \beta _0 + \beta _1 x _n + \epsilon _{n}
\end{align*}$$

##

Эту систему уравнений

$$\begin{align*}
y &_{1} = \beta _0 + \beta _1 x _1 + \epsilon _{1} \\
y &_{2} = \beta _0 + \beta _1 x _2 + \epsilon _{2} \\
&\vdots \\
y &_{n} = \beta _0 + \beta _1 x _n + \epsilon _{n}
\end{align*}$$

можно переписать в виде матриц:

$$\left[\begin{array}{c}
y_1 \\ y_2 \\ \vdots \\ y_n 
\end{array}\right] = 
\left[\begin{array}{cc}
1 & x_1 \\ 1 & x_2 \\ \vdots & \\ 1 & x_n
\end{array}\right] \cdot
\left[\begin{array}{c}
\beta _0 \\ \beta _1
\end{array}\right] +
\left[\begin{array}{c}
\epsilon _1 \\ \epsilon _2 \\ \vdots \\ \epsilon _n
\end{array}\right]
$$

##

Для такой длинной формы записи матриц

$$\left[\begin{array}{c}
y_1 \\ y_2 \\ \vdots \\ y_n 
\end{array}\right] = 
\left[\begin{array}{cc}
1 & x_1 \\ 1 & x_2 \\ \vdots & \\ 1 & x_n
\end{array}\right] \cdot
\left[\begin{array}{c}
\beta _0 \\ \beta _1
\end{array}\right] +
\left[\begin{array}{c}
\epsilon _1 \\ \epsilon _2 \\ \vdots \\ \epsilon _n
\end{array}\right]
$$

есть сокращенная форма записи:

$$Y = X \beta + \epsilon$$

- $Y$ - матрица предсказанных значений, 1 столбец в _n_ строк (_n_ - число наблюдений)
- $X$ - матрица независимых переменных с _n_ строк, ее первый столбец содержит единицы, далее по столбцу для каждой из переменных в модели
- $\beta$ - матрица коэффициентов линейной модели, столбец
- $\epsilon$ - матрица остатков, 1 столбец в _n_ строк


## Задание:

В примере с влиянием удобрений на макрофауну:

- Какова будет размерность матрицы независимых переменных (сколько в ней строк и столбцов)?
- Сколько значений будет в матрице коэффициентов?
- Какова размерность матрицы ошибок?

### Подсказка:

Для модели с одним предиктором матрицы будут выглядеть так

$$\left[\begin{array}{c}
y_1 \\ y_2 \\ \vdots \\ y_n 
\end{array}\right] = 
\left[\begin{array}{cc}
1 & x_1 \\ 1 & x_2 \\ \vdots & \\ 1 & x_n
\end{array}\right] \cdot
\left[\begin{array}{c}
\beta _0 \\ \beta _1
\end{array}\right] +
\left[\begin{array}{c}
\epsilon _1 \\ \epsilon _2 \\ \vdots \\ \epsilon _n
\end{array}\right]
$$

А для модели с несколькими предикторами?

## Как закодировать дискретные предикторы? {.smaller}

У нас два дискретных фактора: 3 времени экспозиции и 2 тритмента. Использована модель эффектов (contr.sum), поэтому переменные-болванки будут закодированы при помощи -1, 0 и 1, так, чтобы сумма кодов для возможных состояний одной переменной была равна нулю.

Вот так будут закодированы уровни фактора "удобрения" с помощью одной переменной-болванки:

```{r}
contr.sum(levels(dat$treat))
```

а так - уровни фактора "время экспозиции" с помощью двух переменных-болванок:

```{r}
contr.sum(levels(dat$time))
```

## Матрица независимых переменных  {.smaller}

Матрица независимых переменных будет содержать интерсепт и 5 переменных болванок.    
- `(Intercept)` - 1,   
фактор "удобрения":  
- `treat1` - опыт закодирован как +1, удобрения -1, (сумма кодов 0)  
фактор "время":  
- `time1` - 2 мес. экспозиции закодировано как +1, 4мес - 0, 6мес - -1 (сумма кодов 0)  
- `time2` - 4 мес. экспозиции закодировано как +1, 2мес - 0, 6мес - -1 (сумма кодов 0)  
взаимодействие факторов:  
- `treat1:time1` - закодирована как произведение `treat1` и `time1` (и сумма кодов 0)  
- `treat1:time2` - закодирована как произведение `treat1` и `time2` (и сумма кодов 0)

```{r}
X <- model.matrix(fit)
X
```


## Матрица коэффициентов линейной регрессии {.smaller}

Всего будет 6 коэффициентов:  
- $\beta_0$ - среднее число видов  
эффект фактора "удобрения":  
- $\beta_1$ - отличие среднего числа видов (в контроле "+", в опыте "-") от общего среднего
эффект фактора "время":  
- $\beta_2$ - общее среднее минус среднее число видов после 2 мес.  
- $\beta_3$ - общее среднее минус среднее число видов после 4 мес.  
поправка на взаимодействие факторов:  
- $\beta_4$ - дополнительное отличие среднего числа видов (в контроле "+", в опыте "-") от общего среднего после 2 мес.  
- $\beta_5$ - дополнительное отличие среднего числа видов (в контроле "+", в опыте "-") от общего среднего после 4 мес.

```{r}
betas <- coef(fit)
betas
```

## Зная коэффициенты, можно вычислить средние значения в группах {.smaller}

| Коэффициенты | $\beta_0$ | $\beta_1$ | $\beta_2$ | $\beta_3$ | $\beta_4$ | $\beta_5$ |
| ------------ | --------- | --------- | --------- | --------- | --------- | --------- |
|   | `r names(betas[1])` | `r names(betas[2])` | `r names(betas[3])` | `r names(betas[4])` | `r names(betas[5])` | `r names(betas[6])` |
|   | `r betas[1]` | `r betas[2]` | `r betas[3]` | `r betas[4]` | `r betas[5]` | `r betas[6]` |

| Средние в группах    | 2m | 4m | 6m | Общие средние |
| --------- | ----- | ----- | ----- | ------ |
| control   | $\beta_0 + \beta_1 + \beta_2 + \beta_4$ | $\beta_0 + \beta_1 + \beta_3 + \beta_5$ | $\beta_0 + \beta_1 - \beta_2 - \beta_3 - \beta_4 - \beta_5$ | $\mu_{c} = \beta_0 + \beta_1$ |
|   | `r betas[1] + betas[2] + betas[3] + betas[5]` | `r betas[1] + betas[2] + betas[4] + betas[6]` | `r betas[1] + betas[2] - betas[3] - betas[4] - betas[5] - betas[6]` | `r betas[1] + betas[2]` |
| treatment | $\beta_0 - \beta_1 + \beta_2 - \beta_4$ | $\beta_0 - \beta_1 + \beta_3 - \beta_5$ | $\beta_0 - \beta_1 - \beta_2 - \beta_3 + \beta_4 + \beta_5$ | $\mu_{tr} = \beta_0 - \beta_1$ |
|  | `r betas[1] - betas[2] + betas[3] - betas[5]` | `r betas[1] - betas[2] + betas[4] - betas[6]` | `r betas[1] - betas[2] - betas[3] - betas[4] + betas[5] + betas[6]` | `r betas[1] - betas[2]` |
| Общие средние | $\mu_{2m} = \beta_0 + \beta_2$ | $\mu_{4m} = \beta_0 + \beta_3$ | $\mu_{6m} = \beta_0 - \beta_2 - \beta_3$ | $\mu = \beta_0$ |
|  | `r betas[1] + betas[3]` | `r betas[1] + betas[4]` | `r betas[1] - betas[3] - betas[4]` | `r betas[1]` |



## Предсказанные значения

$Y = \hat Y + \epsilon = X \beta + \epsilon$

$\hat Y = X \beta$

```{r}
Yhat <- X %*% betas
# значения совпадают с вычисленными автоматически
cbind(Yhat, fitted(fit))
```

## Стандартные ошибки предсказанных значений

Стандартные ошибки предсказанных значений это корень из диагональных элементов матрицы X * cov(betas) * t(X)

```{r}
SE <- sqrt(diag(X %*% vcov(fit) %*% t(X)))
# совпадают с вычисленными автоматически
cbind(SE, predict(fit, se.fit = TRUE)$se)
```

## 95% доверительный интервал

Можем посчитать, зная предсказанные значения и их стандартные ошибки

```{r}
Upr <- Yhat + qnorm(0.975) * SE
Lwr <- Yhat - qnorm(0.975) * SE
cbind(Lwr, Upr, predict(fit, interval = "confidence"))
```


## Take home messages

- Многофакторный дисперсионный анализ позволяет оценить взаимодействие факторов. Если оно значимо, то лучше воздержаться от интерпретации их индивидуальных эффектов
- Если численности групп равны - получаются одинаковые результаты с использованием I, II, III типы сумм квадратов
- В случае, если численности групп неравны (несбалансированные данные) по разному тестируется значимость факторов (I, II, III типы сумм квадратов)



## Дополнительные ресурсы

- Quinn, Keough, 2002, pp. 221-250
- Logan, 2010, pp. 313-359
- Sokal, Rohlf, 1995, pp. 321-362
- Zar, 2010, pp. 246-266
